{% extends "base.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - VK Ads Manager{% endblock %}

{% block content %}
<h2 style="color: #667eea; margin-bottom: 30px;">üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</h2>

{% if not stats %}
    <div class="card">
        <p style="text-align: center; color: #666; padding: 40px;">
            üì≠ –õ–æ–≥–∏ –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.
        </p>
        <div style="text-align: center;">
            <a href="{{ url_for('control') }}" class="btn btn-primary">üöÄ –ü–µ—Ä–µ–π—Ç–∏ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é</a>
        </div>
    </div>
{% else %}
    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏—Å—Ç–æ—á–Ω–∏–∫–µ –¥–∞–Ω–Ω—ã—Ö -->
    <div class="alert alert-success" style="margin-bottom: 20px;">
        üìÑ –î–∞–Ω–Ω—ã–µ –∏–∑ –ª–æ–≥–∞: <code>{{ log_filename }}</code>
    </div>

    <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="grid">
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <h2>{{ stats.total_unprofitable }}</h2>
            <p>–£–±—ã—Ç–æ—á–Ω—ã—Ö –≥—Ä—É–ø–ø</p>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <h2>{{ stats.total_effective }}</h2>
            <p>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –≥—Ä—É–ø–ø</p>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
            <h2>{{ stats.total_testing }}</h2>
            <p>–¢–µ—Å—Ç–∏—Ä—É–µ–º—ã—Ö –≥—Ä—É–ø–ø</p>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
            <h2>{{ "%.2f"|format(stats.total_spent) }}‚ÇΩ</h2>
            <p>–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</p>
        </div>
    </div>

    <!-- –û—Ç–∫–ª—é—á–µ–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã -->
    <div class="card">
        <h3>üî¥ –û—Ç–∫–ª—é—á–µ–Ω–Ω—ã–µ —É–±—ã—Ç–æ—á–Ω—ã–µ –≥—Ä—É–ø–ø—ã ({{ stats.disabled_groups|length }})</h3>
        {% if stats.disabled_groups %}
            <p style="margin-bottom: 15px;">
                <strong>–í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ –≤–ø—É—Å—Ç—É—é:</strong> 
                {{ "%.2f"|format(stats.disabled_groups|sum(attribute='spent')) }}‚ÇΩ
            </p>
            
            <!-- –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞–±–∏–Ω–µ—Ç–∞–º -->
            {% set disabled_by_account = {} %}
            {% for group in stats.disabled_groups %}
                {% if group.account not in disabled_by_account %}
                    {% set _ = disabled_by_account.update({group.account: []}) %}
                {% endif %}
                {% set _ = disabled_by_account[group.account].append(group) %}
            {% endfor %}
            
            {% for account_name, groups in disabled_by_account.items() %}
                <div style="background: #fff5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #dc3545;">
                    <h4 style="color: #dc3545; margin-bottom: 10px;">
                        üè¢ {{ account_name }} 
                        <span style="font-weight: normal; font-size: 14px;">({{ groups|length }} –≥—Ä—É–ø–ø, {{ "%.2f"|format(groups|sum(attribute='spent')) }}‚ÇΩ –≤–ø—É—Å—Ç—É—é)</span>
                    </h4>
                    <table style="margin: 0;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</th>
                                <th>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ (‚ÇΩ)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for group in groups|sort(attribute='spent', reverse=True) %}
                            <tr>
                                <td><code>{{ group.id }}</code></td>
                                <td>{{ group.name }}</td>
                                <td><strong style="color: #dc3545;">{{ "%.2f"|format(group.spent) }}‚ÇΩ</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endfor %}
        {% else %}
            <p style="text-align: center; color: #666; padding: 20px;">
                ‚úÖ –ù–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø (–≤–æ–∑–º–æ–∂–Ω–æ, –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º DRY RUN)
            </p>
        {% endif %}
    </div>

    <!-- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä—É–ø–ø—ã (—Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏) -->
    <div class="card">
        <h3>üü¢ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä—É–ø–ø—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ ({{ stats.effective_groups|length }})</h3>
        {% if stats.effective_groups %}
            <p style="margin-bottom: 15px;">
                <strong>–í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ:</strong> {{ "%.2f"|format(stats.effective_groups|sum(attribute='spent')) }}‚ÇΩ<br>
                <strong>–í—Å–µ–≥–æ —Ü–µ–ª–µ–π:</strong> {{ stats.effective_groups|sum(attribute='goals') }}<br>
                <strong>–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ —Ü–µ–ª–∏:</strong> 
                {% set total_spent = stats.effective_groups|sum(attribute='spent') %}
                {% set total_goals = stats.effective_groups|sum(attribute='goals') %}
                {% if total_goals > 0 %}
                    {{ "%.2f"|format(total_spent / total_goals) }}‚ÇΩ
                {% else %}
                    N/A
                {% endif %}
            </p>
            
            <!-- –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞–±–∏–Ω–µ—Ç–∞–º -->
            {% set effective_by_account = {} %}
            {% for group in stats.effective_groups %}
                {% if group.account not in effective_by_account %}
                    {% set _ = effective_by_account.update({group.account: []}) %}
                {% endif %}
                {% set _ = effective_by_account[group.account].append(group) %}
            {% endfor %}
            
            {% for account_name, groups in effective_by_account.items() %}
                {% set account_spent = groups|sum(attribute='spent') %}
                {% set account_goals = groups|sum(attribute='goals') %}
                <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #28a745;">
                    <h4 style="color: #28a745; margin-bottom: 10px;">
                        üè¢ {{ account_name }} 
                        <span style="font-weight: normal; font-size: 14px;">
                            ({{ groups|length }} –≥—Ä—É–ø–ø, {{ "%.2f"|format(account_spent) }}‚ÇΩ ‚Üí {{ account_goals }} —Ü–µ–ª–µ–π, 
                            —Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞: {{ "%.2f"|format(account_spent / account_goals) if account_goals > 0 else 'N/A' }}‚ÇΩ)
                        </span>
                    </h4>
                    <table style="margin: 0;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</th>
                                <th>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ (‚ÇΩ)</th>
                                <th>–¶–µ–ª–µ–π</th>
                                <th>–¶–µ–Ω–∞ —Ü–µ–ª–∏ (‚ÇΩ)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for group in groups|sort(attribute='goals', reverse=True) %}
                            <tr>
                                <td><code>{{ group.id }}</code></td>
                                <td>{{ group.name }}</td>
                                <td>{{ "%.2f"|format(group.spent) }}‚ÇΩ</td>
                                <td><strong style="color: #28a745;">{{ group.goals }}</strong></td>
                                <td>
                                    {% if group.goals > 0 %}
                                        {{ "%.2f"|format(group.spent / group.goals) }}‚ÇΩ
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endfor %}
        {% else %}
            <p style="text-align: center; color: #666; padding: 20px;">
                üì≠ –ù–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –≥—Ä—É–ø–ø
            </p>
        {% endif %}
    </div>

    <!-- –¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–µ –≥—Ä—É–ø–ø—ã (–±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞, –Ω–æ –≤ —Ä–∞–º–∫–∞—Ö –ª–∏–º–∏—Ç–∞) -->
    <div class="card">
        <h3>‚ö†Ô∏è –¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–µ –≥—Ä—É–ø–ø—ã (–±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞) ({{ stats.testing_groups|length }})</h3>
        {% if stats.testing_groups %}
            <p style="margin-bottom: 15px;">
                <strong>–í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ:</strong> {{ "%.2f"|format(stats.testing_groups|sum(attribute='spent')) }}‚ÇΩ
            </p>
            
            <!-- –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞–±–∏–Ω–µ—Ç–∞–º -->
            {% set testing_by_account = {} %}
            {% for group in stats.testing_groups %}
                {% if group.account not in testing_by_account %}
                    {% set _ = testing_by_account.update({group.account: []}) %}
                {% endif %}
                {% set _ = testing_by_account[group.account].append(group) %}
            {% endfor %}
            
            {% for account_name, groups in testing_by_account.items() %}
                <div style="background: #fffbeb; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                    <h4 style="color: #f59e0b; margin-bottom: 10px;">
                        üè¢ {{ account_name }} 
                        <span style="font-weight: normal; font-size: 14px;">({{ groups|length }} –≥—Ä—É–ø–ø, {{ "%.2f"|format(groups|sum(attribute='spent')) }}‚ÇΩ)</span>
                    </h4>
                    <table style="margin: 0;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</th>
                                <th>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ (‚ÇΩ)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for group in groups|sort(attribute='spent', reverse=True) %}
                            <tr>
                                <td><code>{{ group.id }}</code></td>
                                <td>{{ group.name }}</td>
                                <td>{{ "%.2f"|format(group.spent) }}‚ÇΩ</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endfor %}
        {% else %}
            <p style="text-align: center; color: #666; padding: 20px;">
                üì≠ –ù–µ—Ç —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã—Ö –≥—Ä—É–ø–ø
            </p>
        {% endif %}
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–±–∏–Ω–µ—Ç–∞–º -->
    <div class="card">
        <h3>üè¢ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–±–∏–Ω–µ—Ç–∞–º</h3>
        {% for account_name, account_data in stats.accounts.items() %}
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                <h4 style="color: #667eea; margin-bottom: 15px;">{{ account_name }}</h4>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div>
                        <strong>–õ–∏–º–∏—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤:</strong><br>
                        <span style="font-size: 18px; color: #667eea;">{{ "%.2f"|format(account_data.limit) }}‚ÇΩ</span>
                    </div>
                    <div>
                        <strong>–í—Å–µ–≥–æ –≥—Ä—É–ø–ø:</strong><br>
                        <span style="font-size: 18px;">{{ account_data.total_groups }}</span>
                    </div>
                    <div>
                        <strong>–£–±—ã—Ç–æ—á–Ω—ã—Ö:</strong><br>
                        <span style="font-size: 18px; color: #dc3545;">{{ account_data.unprofitable }}</span>
                    </div>
                    <div>
                        <strong>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö:</strong><br>
                        <span style="font-size: 18px; color: #28a745;">{{ account_data.effective }}</span>
                    </div>
                    <div>
                        <strong>–¢–µ—Å—Ç–∏—Ä—É–µ–º—ã—Ö:</strong><br>
                        <span style="font-size: 18px; color: #ffc107;">{{ account_data.testing }}</span>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <strong>–†–∞—Å—Ö–æ–¥—ã:</strong><br>
                        <span style="font-size: 18px;">{{ "%.2f"|format(account_data.spent) }}‚ÇΩ</span>
                    </div>
                    <div>
                        <strong>VK —Ü–µ–ª–∏:</strong><br>
                        <span style="font-size: 18px;">{{ account_data.goals }}</span>
                    </div>
                    <div>
                        <strong>–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ —Ü–µ–ª–∏:</strong><br>
                        <span style="font-size: 18px;">
                            {% if account_data.goals > 0 %}
                                {{ "%.2f"|format(account_data.spent / account_data.goals) }}‚ÇΩ
                            {% else %}
                                N/A
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="card">
        <h3>‚ÑπÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
        <ul style="line-height: 1.8;">
            <li><strong>–£–±—ã—Ç–æ—á–Ω—ã–µ –≥—Ä—É–ø–ø—ã</strong> ‚Äî –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ –±–æ–ª—å—à–µ –ª–∏–º–∏—Ç–∞ –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (VK —Ü–µ–ª–µ–π = 0)</li>
            <li><strong>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –≥—Ä—É–ø–ø—ã</strong> ‚Äî –ø—Ä–∏–Ω–µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É VK —Ü–µ–ª—å (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤)</li>
            <li><strong>–¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–µ –≥—Ä—É–ø–ø—ã</strong> ‚Äî –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ –º–µ–Ω—å—à–µ –ª–∏–º–∏—Ç–∞ –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ–∫–∞</li>
            <li><strong>–û—Ç–∫–ª—é—á–µ–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã</strong> ‚Äî —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–µ —É–±—ã—Ç–æ—á–Ω—ã–µ –≥—Ä—É–ø–ø—ã (–µ—Å–ª–∏ –Ω–µ DRY RUN —Ä–µ–∂–∏–º)</li>
        </ul>
    </div>
{% endif %}
{% endblock %}
