{% extends "base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ - VK Ads Manager{% endblock %}

{% block content %}
<h2 style="color: #667eea; margin-bottom: 30px;">üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏</h2>

<!-- –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ -->
<div class="card">
    <h3>‚è∞ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á</h3>
    <p style="margin-bottom: 20px;">
        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é. –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥–≤–æ–π–Ω–æ–π –∞–Ω–∞–ª–∏–∑ (–æ—Å–Ω–æ–≤–Ω–æ–π + —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π) 
        —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º, —É–∫–∞–∑–∞–Ω–Ω—ã–º –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.
    </p>
    
    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
        <table style="margin: 0;">
            <tr>
                <td style="border: none; padding: 5px;"><strong>–°—Ç–∞—Ç—É—Å:</strong></td>
                <td style="border: none; padding: 5px;">
                    <span id="scheduler-status" class="badge {% if scheduler_running %}badge-success{% else %}badge-danger{% endif %}">
                        {% if scheduler_running %}üü¢ –ó–∞–ø—É—â–µ–Ω{% else %}üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω{% endif %}
                    </span>
                </td>
            </tr>
            <tr>
                <td style="border: none; padding: 5px;"><strong>–ò–Ω—Ç–µ—Ä–≤–∞–ª:</strong></td>
                <td style="border: none; padding: 5px;">{{ config.scheduler.interval_minutes }} –º–∏–Ω—É—Ç</td>
            </tr>
            <tr>
                <td style="border: none; padding: 5px;"><strong>–í–∫–ª—é—á–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö:</strong></td>
                <td style="border: none; padding: 5px;">
                    {% if config.scheduler.enabled %}
                        <span class="badge badge-success">–î–∞ ‚úÖ</span>
                    {% else %}
                        <span class="badge badge-danger">–ù–µ—Ç ‚ùå</span>
                    {% endif %}
                </td>
            </tr>
        </table>
    </div>
    
    {% if not config.scheduler.enabled %}
        <div class="alert alert-error" style="margin-bottom: 20px;">
            ‚ö†Ô∏è –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ—Ç–∫–ª—é—á–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö! –í–∫–ª—é—á–∏—Ç–µ –µ–≥–æ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞–±–æ—Ç—ã.
        </div>
    {% endif %}
    
    <div style="display: flex; gap: 10px;">
        {% if not scheduler_running %}
            <form action="{{ url_for('start_scheduler') }}" method="POST" style="display: inline;">
                <button type="submit" class="btn btn-primary" {% if not config.scheduler.enabled %}disabled title="–í–∫–ª—é—á–∏—Ç–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö"{% endif %}>
                    ‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
                </button>
            </form>
        {% else %}
            <form action="{{ url_for('stop_scheduler') }}" method="POST" style="display: inline;" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫?')">
                <button type="submit" class="btn btn-danger">
                    ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
                </button>
            </form>
        {% endif %}
        
        <a href="{{ url_for('settings') }}" class="btn btn-secondary">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞</a>
    </div>
    
    <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 5px; border-left: 4px solid #2196f3;">
        <p style="margin: 0; font-size: 14px;">
            <strong>‚ÑπÔ∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong><br>
            –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∞–Ω–∞–ª–∏–∑ VK Ads –∫–∞–∂–¥—ã–µ <strong>{{ config.scheduler.interval_minutes }} –º–∏–Ω—É—Ç</strong>. 
            –ö–∞–∂–¥—ã–π –∑–∞–ø—É—Å–∫ –≤–∫–ª—é—á–∞–µ—Ç –¥–≤–∞ –ø—Ä–æ—Ö–æ–¥–∞: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ + —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–æ —Å–ª—É—á–∞–π–Ω–æ–π –ø—Ä–∏–±–∞–≤–∫–æ–π 5-30 –¥–Ω–µ–π.
        </p>
    </div>
</div>

<!-- –ï–¥–∏–Ω–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ -->
<div class="card">
    <h3>üöÄ –ï–¥–∏–Ω–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h3>
    <p style="margin-bottom: 20px;">
        –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ VK Ads –≤—Ä—É—á–Ω—É—é (–æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ). –ü—Ä–æ—Ü–µ—Å—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ.
    </p>
    
    <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
        <table style="margin: 0;">
            <tr>
                <td style="border: none; padding: 5px;"><strong>–°—Ç–∞—Ç—É—Å:</strong></td>
                <td style="border: none; padding: 5px;">
                    <span id="analysis-status" class="badge {% if analysis_running %}badge-success{% else %}badge-danger{% endif %}">
                        {% if analysis_running %}üü¢ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è{% else %}üî¥ –ù–µ –∑–∞–ø—É—â–µ–Ω{% endif %}
                    </span>
                </td>
            </tr>
            <tr>
                <td style="border: none; padding: 5px;"><strong>–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:</strong></td>
                <td style="border: none; padding: 5px;">
                    {% if config.analysis_settings.dry_run %}
                        <span class="badge badge-success">DRY RUN (—Ç–µ—Å—Ç–æ–≤—ã–π)</span>
                    {% else %}
                        <span class="badge badge-danger">PRODUCTION (–±–æ–µ–≤–æ–π)</span>
                    {% endif %}
                </td>
            </tr>
        </table>
    </div>
    
    <div style="display: flex; gap: 10px;">
        {% if not analysis_running %}
            <form action="{{ url_for('start_analysis') }}" method="POST" style="display: inline;">
                <button type="submit" class="btn btn-primary">
                    üéØ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ —Å–µ–π—á–∞—Å
                </button>
            </form>
        {% else %}
            <form action="{{ url_for('stop_analysis') }}" method="POST" style="display: inline;" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑?')">
                <button type="submit" class="btn btn-danger">
                    ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑
                </button>
            </form>
        {% endif %}
        
        <a href="{{ url_for('logs') }}" class="btn btn-secondary">üìù –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏</a>
    </div>
    
    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
        <p style="margin: 0; font-size: 14px;">
            <strong>‚ö†Ô∏è –í–∞–∂–Ω–æ:</strong><br>
            –ü—Ä–æ—Ü–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ. –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–¥–µ–ª "–õ–æ–≥–∏" –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É <code>logs/</code>.
        </p>
    </div>
</div>

<!-- –õ–æ–≥–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ -->
<div class="card">
    <h3>üìã –õ–æ–≥–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞</h3>
    <p style="margin-bottom: 20px;">
        –õ–æ–≥–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –≤ –ø–∞–ø–∫–µ <code>scheduler/logs/</code>
    </p>
    
    {% set scheduler_log_dir = "scheduler/logs" %}
    {% if scheduler_log_dir %}
        <a href="{{ url_for('logs') }}" class="btn btn-secondary">üìÇ –û—Ç–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É —Å –ª–æ–≥–∞–º–∏</a>
    {% endif %}
</div>

<!-- –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –í–°–ï–• –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ -->
<div class="card" style="border: 2px solid #dc3545; background: #fff5f5;">
    <h3 style="color: #dc3545;">üö® –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞</h3>
    <p style="margin-bottom: 20px;">
        –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã –∑–∞–ø—É—â–µ–Ω—ã –≤—Ä—É—á–Ω—É—é (–≤–Ω–µ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏) –∏–ª–∏ "–∑–∞–≤–∏—Å–ª–∏".
        <br><strong>–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –í–°–ï –ø—Ä–æ—Ü–µ—Å—Å—ã:</strong> <code>scheduler_main.py</code> –∏ <code>main.py</code>
    </p>
    
    <form action="{{ url_for('kill_all') }}" method="POST" style="display: inline;" onsubmit="return confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–≠—Ç–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç –í–°–ï –ø—Ä–æ—Ü–µ—Å—Å—ã scheduler_main.py –∏ main.py, –¥–∞–∂–µ —Ç–µ, —á—Ç–æ –∑–∞–ø—É—â–µ–Ω—ã –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª!\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')">
        <button type="submit" class="btn btn-danger" style="background: #dc3545;">
            üî• –£–ë–ò–¢–¨ –í–°–ï –ü–†–û–¶–ï–°–°–´
        </button>
    </form>
    
    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
        <p style="margin: 0; font-size: 13px;">
            <strong>‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –≤ –∫—Ä–∞–π–Ω–µ–º —Å–ª—É—á–∞–µ!</strong><br>
            –≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –Ω–∞–π–¥–µ—Ç –∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç –≤—Å–µ Python –ø—Ä–æ—Ü–µ—Å—Å—ã —Å <code>scheduler_main.py</code> –∏ <code>main.py</code>, 
            –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω–∏ –±—ã–ª–∏ –∑–∞–ø—É—â–µ–Ω—ã (—á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –∏–ª–∏ –≤—Ä—É—á–Ω—É—é).
        </p>
    </div>
</div>

<script>
// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
setInterval(function() {
    fetch('{{ url_for("control_status") }}')
        .then(response => response.json())
        .then(data => {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
            const schedulerStatus = document.getElementById('scheduler-status');
            if (data.scheduler_running) {
                schedulerStatus.className = 'badge badge-success';
                schedulerStatus.textContent = 'üü¢ –ó–∞–ø—É—â–µ–Ω';
            } else {
                schedulerStatus.className = 'badge badge-danger';
                schedulerStatus.textContent = 'üî¥ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–Ω–∞–ª–∏–∑–∞
            const analysisStatus = document.getElementById('analysis-status');
            if (data.analysis_running) {
                analysisStatus.className = 'badge badge-success';
                analysisStatus.textContent = 'üü¢ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è';
            } else {
                analysisStatus.className = 'badge badge-danger';
                analysisStatus.textContent = 'üî¥ –ù–µ –∑–∞–ø—É—â–µ–Ω';
            }
        })
        .catch(error => console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error));
}, 5000);
</script>
{% endblock %}
